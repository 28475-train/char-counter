<!DOCTYPE html>
<html lang="ja" data-view="">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>文字数カウント & 保存ツール</title>

<style>
:root{
  --bg:#ffffff;
  --card:#f9fafb;
  --accent:#22c55e;
  --accent-soft:#dcfce7;
  --text:#1f2937;
  --border:#e5e7eb;
}

body{
  font-family:"Noto Sans JP",system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
  max-width:720px;
  margin:30px auto;
  padding:20px;
}

h1{margin-top:0}

.card{
  background:var(--card);
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
  border:1px solid var(--border);
}

.notice{
  background:var(--accent-soft);
  border-left:6px solid var(--accent);
  padding:12px;
  border-radius:10px;
  margin-bottom:16px;
  font-size:.95em;
}

.notice-item{
  margin-top:10px;
  padding-top:10px;
  border-top:1px dashed #86efac;
}
.notice-date{
  font-size:.8em;
  color:#166534;
}
.notice-title{
  font-weight:bold;
}

textarea{
  width:100%;
  min-height:160px;
  padding:12px;
  font-size:1em;
  border-radius:10px;
  border:1px solid var(--border);
}

.controls button, select, input[type=number]{
  padding:6px 10px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
}

.controls button:hover{
  background:var(--accent-soft);
}

.info p{margin:4px 0}

.save-btn{
  background:var(--accent);
  color:#fff;
  border:none;
}

.settings-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  padding:10px 14px;
  border:none;
  border-radius:50px;
  background:var(--accent);
  color:#fff;
}

.ad-sp{display:none}
.ad-pc{display:block}
html[data-view="sp"] .ad-sp{display:block}
html[data-view="sp"] .ad-pc{display:none}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:flex;
  align-items:center;
  justify-content:center;
}
.modal.hidden{display:none}

.modal-box{
  background:#fff;
  border-radius:14px;
  padding:20px;
  max-width:420px;
  width:100%;
}
</style>
</head>

<body>

<script>
/* 初回同意チェック */
if(localStorage.getItem('agreed')!=='true'){
  location.href='index.html';
}
</script>

<h1>文字数カウント & 保存ツール</h1>

<!-- お知らせ -->
<div class="notice">
  <strong>お知らせ</strong>
  <div id="noticeList">読み込み中...</div>
</div>

<div class="card">

<div class="controls">
  上限文字数：
  <button onclick="setLimit(280)">280</button>
  <button onclick="setLimit(500)">500</button>
  <button onclick="setLimit(1000)">1000</button>
  カスタム
  <input type="number" id="customLimit" min="1" style="width:80px">
  <button onclick="setCustom()">設定</button>
</div>

<textarea id="text" placeholder="ここにテキストを入力してください..."></textarea>

<div class="info">
  <p>文字数: <span id="char">0</span></p>
  <p>行数: <span id="line">1</span></p>
  <p>残り文字数: <span id="remain">280</span></p>
</div>

<div class="controls">
  保存形式：
  <select id="format">
    <option value="txt">TXT</option>
    <option value="md">Markdown</option>
    <option value="csv">CSV</option>
  </select>
  <button class="save-btn" onclick="download()">保存</button>
</div>

</div>

<!-- 広告 -->
<div class="ad-sp">
<script src="https://adm.shinobi.jp/s/727078061892c6b6db2f17ceaf739873"></script>
</div>

<div class="ad-pc">
<script src="https://adm.shinobi.jp/s/025d5af8ede4ff475032852f62945fae"></script>
</div>

<button class="settings-btn" onclick="openSettings()">⚙</button>

<!-- 設定モーダル -->
<div id="settings" class="modal hidden">
  <div class="modal-box">
    <h2>ユーザー設定</h2>

    <p>表示モード</p>
    <label><input type="radio" name="view" value="sp"> スマホ</label><br>
    <label><input type="radio" name="view" value="pc"> PC</label>

    <p>
      <label>
        <input type="checkbox" id="adsToggle">
        広告を表示する
      </label>
    </p>

    <ul>
      <li><a href="terms.html" target="_blank">利用規約</a></li>
      <li><a href="terms.html#privacy" target="_blank">プライバシーポリシー</a></li>
    </ul>

    <button onclick="closeSettings()">閉じる</button>
  </div>
</div>

<script>
/* ===== お知らせ取得（GAS） ===== */
fetch("https://script.google.com/macros/s/AKfycbxmgrljU-iNc8kpe7uZ3fDIAYGjE9JNq5ENi8wG6w7mPcBbg5F601rosrJ4ZNVUOUg/exec")
  .then(r=>r.json())
  .then(list=>{
    const box=document.getElementById('noticeList');
    if(!list.length){
      box.textContent='現在お知らせはありません';
      return;
    }
    box.innerHTML='';
    list.forEach(n=>{
      const d=document.createElement('div');
      d.className='notice-item';
      d.innerHTML=`
        <div class="notice-date">${n.date}</div>
        <div class="notice-title">${n.title}</div>
        <div>${n.body.replace(/\n/g,'<br>')}</div>
      `;
      box.appendChild(d);
    });
  })
  .catch(()=>{
    document.getElementById('noticeList').textContent='お知らせを取得できませんでした';
  });

/* ===== カウント ===== */
let LIMIT=280;
const text=document.getElementById('text');
const char=document.getElementById('char');
const line=document.getElementById('line');
const remain=document.getElementById('remain');

function update(){
  let v=text.value;
  if(v.length>LIMIT){
    v=v.slice(0,LIMIT);
    text.value=v;
  }
  char.textContent=v.length;
  line.textContent=v.split('\n').length;
  remain.textContent=LIMIT-v.length;
}
text.addEventListener('input',update);

function setLimit(n){LIMIT=n;update();}
function setCustom(){
  const n=Number(customLimit.value);
  if(n>0){LIMIT=n;update();}
}

/* ===== 表示モード ===== */
const view=localStorage.getItem('viewMode');
if(view){
  document.documentElement.setAttribute('data-view',view);
}

/* ===== 設定 ===== */
const modal=document.getElementById('settings');
const adsToggle=document.getElementById('adsToggle');

function openSettings(){
  modal.classList.remove('hidden');
  document.querySelectorAll('input[name=view]').forEach(r=>{
    r.checked=r.value===localStorage.getItem('viewMode');
  });
  adsToggle.checked=localStorage.getItem('showAds')!=='false';
}
function closeSettings(){modal.classList.add('hidden');}

document.querySelectorAll('input[name=view]').forEach(r=>{
  r.onchange=()=>{
    localStorage.setItem('viewMode',r.value);
    document.documentElement.setAttribute('data-view',r.value);
  };
});

adsToggle.onchange=()=>{
  localStorage.setItem('showAds',adsToggle.checked?'true':'false');
  location.reload();
};

/* ===== 保存 ===== */
function download(){
  const f=format.value;
  const d=new Date();
  const name=`text_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}.${f}`;
  let c=text.value;
  if(f==='csv'){c=`"${c.replace(/"/g,'""')}"`;}
  const b=new Blob([c],{type:'text/plain;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(b);
  a.download=name;
  a.click();
  URL.revokeObjectURL(a.href);
}
</script>

</body>
</html>
