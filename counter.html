<!DOCTYPE html>
<html lang="ja" data-view="" data-ads="true">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>文字数カウント & 保存ツール</title>

<style>
:root{
  --bg:#ffffff;
  --card:#f9fafb;
  --accent:#22c55e;
  --accent-soft:#dcfce7;
  --text:#1f2937;
  --border:#e5e7eb;
}

body{
  font-family:"Noto Sans JP",system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
  max-width:720px;
  margin:30px auto;
  padding:20px;
}

h1{margin-top:0}

.card{
  background:var(--card);
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
  border:1px solid var(--border);
}

.notice{
  background:var(--accent-soft);
  border-left:6px solid var(--accent);
  padding:12px;
  border-radius:10px;
  margin-bottom:16px;
  font-size:.95em;
}

.notice-item{
  margin-top:10px;
  padding-top:10px;
  border-top:1px dashed #86efac;
}
.notice-date{
  font-size:.8em;
  color:#166534;
}
.notice-title{
  font-weight:bold;
}

textarea{
  width:100%;
  min-height:160px;
  padding:12px;
  font-size:1em;
  border-radius:10px;
  border:1px solid var(--border);
}

.controls button, select, input[type=number]{
  padding:6px 10px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
}

.controls button:hover{
  background:var(--accent-soft);
}

.info p{margin:4px 0}

/* 保存ボタンのデザインをより目立たせる */
.save-btn{
  background:var(--accent);
  color:#fff;
  border:none;
  font-weight: bold;
  padding: 8px 16px; /* サイズを大きく */
}

.save-btn:hover{
  filter: brightness(1.1); /* ホバーで明るく */
  background:var(--accent);
}

/* すべてクリアボタンのスタイルを追加 */
.clear-btn {
  background: #f87171; /* 赤色系 */
  color: #fff;
  border: none;
  font-weight: bold;
  padding: 8px 16px;
  margin-left: 8px; /* 保存ボタンとの間隔 */
}

.clear-btn:hover {
  background: #ef4444; /* ホバーで濃い赤 */
}


.settings-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  padding:10px 14px;
  border:none;
  border-radius:50px;
  background:var(--accent);
  color:#fff;
}

/* 広告表示の制御 */
.ad-sp{display:none}
.ad-pc{display:block}
html[data-view="sp"] .ad-sp{display:block}
html[data-view="sp"] .ad-pc{display:none}

/* 設定で広告をOFFにした場合、広告ブロックを完全に非表示にする */
html[data-ads="false"] .ad-sp,
html[data-ads="false"] .ad-pc {
  display: none !important;
}


.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:flex;
  align-items:center;
  justify-content:center;
}
.modal.hidden{display:none}

.modal-box{
  background:#fff;
  border-radius:14px;
  padding:20px;
  max-width:420px;
  width:100%;
}
</style>
</head>

<body>

<script>
/* 初回同意チェック */
if(localStorage.getItem('agreed')!=='true'){
  location.href='index.html';
}
</script>

<h1>文字数カウント & 保存ツール</h1>

<div style="text-align:right; font-size:0.9em; margin-bottom:16px;">
  訪問回数: <span id="accessCounter" style="font-weight:bold;">読み込み中...</span>
</div>

<div class="notice">
  <strong>お知らせ</strong>
  <div id="noticeList">読み込み中...</div>
</div>

<div class="card">

<div class="controls">
  上限文字数：
  <button onclick="setLimit(280)">280</button>
  <button onclick="setLimit(500)">500</button>
  <button onclick="setLimit(1000)">1000</button>
  カスタム
  <input type="number" id="customLimit" min="1" style="width:80px">
  <button onclick="setCustom()">設定</button>
</div>

<textarea id="text" placeholder="ここにテキストを入力してください..."></textarea>

<div class="info">
  <p>文字数: <span id="char">0</span></p>
  <p>行数: <span id="line">1</span></p>
  <p>残り文字数: <span id="remain">280</span></p>
</div>

<div class="controls">
  保存形式：
  <select id="format">
    <option value="txt">TXT</option>
    <option value="md">Markdown</option>
    <option value="csv">CSV</option>
  </select>
  <button class="save-btn" onclick="download()">保存</button>
  <button class="clear-btn" onclick="clearText()">すべてクリア</button>
</div>

</div>

<div class="ad-sp">
<script src="https://adm.shinobi.jp/s/727078061892c6b6db2f17ceaf739873"></script>
</div>

<div class="ad-pc">
<script src="https://adm.shinobi.jp/s/025d5af8ede4ff475032852f62945fae"></script>
</div>

<button class="settings-btn" onclick="openSettings()">⚙</button>

<div id="settings" class="modal hidden">
  <div class="modal-box">
    <h2>ユーザー設定</h2>

    <p>表示モード</p>
    <label><input type="radio" name="view" value="sp"> スマホ</label><br>
    <label><input type="radio" name="view" value="pc"> PC</label>

    <p>
      <label>
        <input type="checkbox" id="adsToggle">
        広告を表示する
      </label>
    </p>

    <ul>
      <li><a href="terms.html" target="_blank">利用規約</a></li>
      <li><a href="terms.html#privacy" target="_blank">プライバシーポリシー</a></li>
    </ul>

    <button onclick="closeSettings()">閉じる</button>
  </div>
</div>

<script>
/* ===== アクセスカウンター (GAS連携) ===== */
// ★提供いただいたGASのURLを設定済み
const ACCESS_GAS_URL = "https://script.google.com/macros/s/AKfycbwALCjWmxSF-IzTP3bBp_wdlo-5k_Wuag1dH0D3cuUg5pYqLf6E2cf2L1NcIY476DqyHw/exec"; 

const accessCounterElement = document.getElementById('accessCounter');

function fetchAccessCount() {
  fetch(ACCESS_GAS_URL)
    .then(response => {
      if (!response.ok) {
        throw new Error(`GASアクセスエラー: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data && data.count !== undefined) {
        // カウントを3桁区切りで表示
        accessCounterElement.textContent = data.count.toLocaleString();
      } else {
        accessCounterElement.textContent = 'エラー';
      }
    })
    .catch(error => {
      console.error('アクセスカウンター取得中にエラーが発生しました:', error);
      accessCounterElement.textContent = '取得失敗';
    });
}

// ページロード時にカウンターを読み込む
window.addEventListener('load', fetchAccessCount);


/* ===== お知らせ取得（GAS） ===== */
fetch("https://script.google.com/macros/s/AKfycbxmgrljU-iNc8kpe7uZ3fDIAYGjE9JNq5ENi8wG6w7mPcBbg5F601rosrJ4ZNVUOUg/exec")
  .then(r=>r.json())
  .then(list=>{
    const box=document.getElementById('noticeList');
    if(!list.length){
      box.textContent='現在お知らせはありません';
      return;
    }
    box.innerHTML='';
    list.forEach(n=>{
      const d=document.createElement('div');
      d.className='notice-item';
      d.innerHTML=`
        <div class="notice-date">${n.date}</div>
        <div class="notice-title">${n.title}</div>
        <div>${n.body.replace(/\n/g,'<br>')}</div>
      `;
      box.appendChild(d);
    });
  })
  .catch(()=>{
    document.getElementById('noticeList').textContent='お知らせを取得できませんでした';
  });

/* ===== カウント ===== */
let LIMIT = 280; // 初期値を280に設定
const text = document.getElementById('text');
const char = document.getElementById('char');
const line = document.getElementById('line');
const remain = document.getElementById('remain');
const customLimitInput = document.getElementById('customLimit');

function update() {
  const v = text.value;
  const currentLength = v.length;
  const currentLines = v.split('\n').length;
  const remainingCount = LIMIT - currentLength;

  char.textContent = currentLength;
  line.textContent = currentLines;
  remain.textContent = remainingCount;

  // 制限を超えた場合に色を変更（自動切り捨ては行わない）
  if (remainingCount < 0) {
    remain.style.color = 'red';
    remain.style.fontWeight = 'bold';
  } else {
    remain.style.color = '';
    remain.style.fontWeight = '';
  }
}

// 初期設定とイベントリスナーの設定
function initializeCounter() {
  // 保存されたカスタム制限値があれば読み込む
  const storedLimit = localStorage.getItem('charLimit');
  if (storedLimit && !isNaN(storedLimit) && Number(storedLimit) > 0) {
    LIMIT = Number(storedLimit);
    customLimitInput.value = LIMIT;
  } else {
     customLimitInput.value = LIMIT;
  }
  update(); // ページロード時に一度カウントを更新
  text.addEventListener('input', update);
}

function setLimit(n) {
  LIMIT = n;
  localStorage.setItem('charLimit', n); // 制限値を保存
  customLimitInput.value = n; // カスタム入力欄を更新
  update();
}

function setCustom() {
  const n = Number(customLimitInput.value);
  if (n > 0) {
    setLimit(n);
  } else {
    alert('上限文字数には1以上の数字を入力してください。');
  }
}

// ページロード時に初期化関数を呼び出す
window.addEventListener('load', initializeCounter);


/* ===== すべてクリア機能 ===== */
function clearText() {
  if (confirm('入力内容をすべて消去してもよろしいですか？この操作は元に戻せません。')) {
    text.value = '';
    update(); // カウントをリセット
  }
}


/* ===== 表示モード / 広告設定の初期読み込み ===== */
const view = localStorage.getItem('viewMode');
if (view) {
  document.documentElement.setAttribute('data-view', view);
}

const ads = localStorage.getItem('showAds');
// localStorageに設定がなければデフォルトは'true'（表示）
// 'false'が設定されていれば、data-ads="false"を付与し、CSSで非表示にする
document.documentElement.setAttribute('data-ads', ads === 'false' ? 'false' : 'true');


/* ===== 設定 ===== */
const modal=document.getElementById('settings');
const adsToggle=document.getElementById('adsToggle');

function openSettings(){
  modal.classList.remove('hidden');
  document.querySelectorAll('input[name=view]').forEach(r=>{
    r.checked=r.value===localStorage.getItem('viewMode');
  });
  adsToggle.checked=localStorage.getItem('showAds')!=='false';
}
function closeSettings(){modal.classList.add('hidden');}

document.querySelectorAll('input[name=view]').forEach(r=>{
  r.onchange=()=>{
    localStorage.setItem('viewMode',r.value);
    document.documentElement.setAttribute('data-view',r.value);
  };
});

adsToggle.onchange=()=>{
  const isChecked = adsToggle.checked;
  localStorage.setItem('showAds', isChecked ? 'true' : 'false');
  // 広告表示設定を即座に<html>タグに反映
  document.documentElement.setAttribute('data-ads', isChecked ? 'true' : 'false');
};

/* ===== 保存（文字化け対策済み） ===== */
function download(){
  const f = document.getElementById('format').value;
  const d = new Date();
  
  // ファイル名の生成
  const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
  const timeStr = `${String(d.getHours()).padStart(2, '0')}${String(d.getMinutes()).padStart(2, '0')}`;
  const name = `text_${dateStr}_${timeStr}.${f}`;
  
  let c = text.value;
  
  // CSV形式の処理
  if (f === 'csv') {
      // 引用符を二重化し、全体を引用符で囲む
      c = `"${c.replace(/"/g, '""')}"`; 
  }
  
  // 1. BOM (Byte Order Mark) の追加
  // Windows環境での文字化けを防ぐため、UTF-8 BOM付きにする
  const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
  
  // 2. テキストコンテンツの生成
  const textBlob = new Blob([c], {type: 'text/plain;charset=utf-8;'});
  
  // 3. BOMとテキストコンテンツを結合
  const b = new Blob([bom, textBlob], {type: 'text/plain;charset=utf-8'});

  const a = document.createElement('a');
  a.href = URL.createObjectURL(b);
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}
</script>

</body>
</html>
