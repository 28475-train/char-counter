<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CLOUD MEMO | 篠ノ井乗務区</title>
    <style>
        /* 全体設定 */
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* ゲーミングカーソル（未ログイン：緑） */
        html, body, * {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="5" fill="%2300ffaa" stroke="white" stroke-width="1"/><path d="M16 0v32M0 16h32" stroke="%2300ffaa" stroke-width="1" stroke-dasharray="2,2"/></svg>') 16 16, auto !important;
        }

        /* ログイン済みの青カーソル */
        body.is-logged-in, body.is-logged-in * {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="5" fill="%2300aaff" stroke="white" stroke-width="1"/><path d="M16 0v32M0 16h32" stroke="%2300aaff" stroke-width="1" stroke-dasharray="2,2"/></svg>') 16 16, auto !important;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: 'Share Tech Mono', monospace, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .container {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .title {
            color: #00ffaa;
            font-size: 0.8rem;
            letter-spacing: 2px;
        }

        body.is-logged-in .title {
            color: #00aaff;
        }

        #status {
            font-size: 0.6rem;
            color: #555;
            transition: color 0.3s;
        }

        textarea {
            flex: 1;
            background: #050505;
            border: 1px solid #222;
            color: #fff;
            padding: 15px;
            font-size: 16px; /* スマホズーム防止 */
            border-radius: 12px;
            resize: none;
            outline: none;
            line-height: 1.6;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        textarea:focus {
            border-color: #00aaff;
            box-shadow: 0 0 15px rgba(0, 170, 255, 0.1);
        }

        .footer {
            display: flex;
            gap: 10px;
            padding: 10px 15px calc(15px + env(safe-area-inset-bottom));
        }

        .btn {
            flex: 1;
            background: #111;
            border: 1px solid #333;
            color: #888;
            padding: 14px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
            text-align: center;
            transition: 0.2s;
        }

        .btn:active {
            background: #00aaff;
            color: #000;
            border-color: #00aaff;
            transform: scale(0.98);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="title">CLOUD_MEMO_PROTOCOL</div>
        <div id="status">INITIALIZING...</div>
    </div>

    <textarea id="memo-box" placeholder="データを読み込み中..."></textarea>
</div>

<div class="footer">
    <button class="btn" onclick="location.href='index.html'">CLOSE</button>
    <button class="btn" onclick="manualSync()">FORCE_SYNC</button>
    <button class="btn" onclick="clearMemo()">PURGE</button>
</div>

<script>
    // あなたのAPI URLをセット済み
    const API_URL = "https://script.google.com/macros/s/AKfycbxkgbAIzQLw2N__Vwt8NjNWJA9srFxb5wbPLNDW5Tg47p1VehTM8t2RQtsRWLha3K2P/exec"; 
    
    const memoBox = document.getElementById('memo-box');
    const statusLabel = document.getElementById('status');
    const authKey = 'shinorail_consent_v1';

    // ログイン状態（カーソル色）の反映
    if (localStorage.getItem(authKey)) {
        document.body.classList.add('is-logged-in');
    }

    // クラウドからデータ取得
    async function loadMemo() {
        statusLabel.innerText = "STATUS: CONNECTING...";
        statusLabel.style.color = "#00ffaa";

        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            if (data.content !== undefined) {
                memoBox.value = data.content;
                statusLabel.innerText = "STATUS: ONLINE";
                statusLabel.style.color = "#00aaff";
            }
        } catch (e) {
            console.error(e);
            statusLabel.innerText = "STATUS: OFFLINE";
            statusLabel.style.color = "#ff0044";
            // オフライン時はローカルから復元
            memoBox.value = localStorage.getItem('shinorail_memo_backup') || "";
        }
    }

    // クラウドへ保存
    async function saveMemo() {
        const content = memoBox.value;
        // ローカルにバックアップ
        localStorage.setItem('shinorail_memo_backup', content);
        
        statusLabel.innerText = "STATUS: UPLOADING...";
        statusLabel.style.color = "#ffffff";

        try {
            // POSTリクエスト
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ content: content })
            });
            statusLabel.innerText = "STATUS: SYNCED";
            statusLabel.style.color = "#00aaff";
        } catch (e) {
            statusLabel.innerText = "STATUS: SYNC_ERROR";
            statusLabel.style.color = "#ff0044";
        }
    }

    // 入力監視：タイピングが止まって1.2秒後に自動送信
    let timer;
    memoBox.addEventListener('input', () => {
        statusLabel.innerText = "STATUS: EDITING...";
        statusLabel.style.color = "#ffaa00";
        clearTimeout(timer);
        timer = setTimeout(saveMemo, 1200);
    });

    // 手動同期
    function manualSync() {
        saveMemo();
    }

    // 全消去
    function clearMemo() {
        if (confirm("全てのクラウドデータを消去しますか？")) {
            memoBox.value = "";
            saveMemo();
        }
    }

    // 起動時にロードを実行
    window.onload = loadMemo;
</script>

</body>
</html>
