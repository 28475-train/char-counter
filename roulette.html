<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ルーレット | 篠ノ井乗務区</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #roulette-display {
            height: 150px;
            background: #ffffff;
            border: 4px solid var(--accent, #4CAF50);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
        }
        body.member-mode #roulette-display {
            background: #1e293b;
        }
        #roulette-target {
            font-size: 2.4rem;
            font-weight: 900;
            color: var(--text);
            text-align: center;
        }
        .row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .input-field {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid var(--border, #e2e8f0);
            background: var(--card, #fff);
            color: var(--text, #333);
            font-size: 16px;
        }
        .del-btn {
            background: #f43f5e;
            color: white;
            border: none;
            border-radius: 12px;
            width: 44px;
            font-weight: bold;
            cursor: pointer;
        }
        .add-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px dashed var(--accent, #4CAF50);
            color: var(--accent, #4CAF50);
            border-radius: 15px;
            font-weight: bold;
            margin: 10px 0 20px;
            cursor: pointer;
        }
        .history-list {
            background: var(--card, #fff);
            border: 1px solid var(--border, #e2e8f0);
            border-radius: 15px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
        }
        .history-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border, #e2e8f0);
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <a href="index.html" class="logo-text">ROULETTE</a>
            <div id="status-area"></div>
        </div>
    </header>

    <main class="container">
        <div class="btn-group">
            <button class="menu-btn" onclick="location.href='index.html'">ホーム</button>
            <button class="menu-btn" onclick="clearHistory()">履歴削除</button>
        </div>

        <div class="custom-form">
            <div id="roulette-display">
                <div id="roulette-target">READY</div>
            </div>

            <div style="text-align: left;">
                <label style="font-size: 0.8rem; font-weight: bold; opacity: 0.7;">抽選項目</label>
                <div id="items-wrapper" style="margin-top: 10px;"></div>
                <button class="add-btn" onclick="addNewRow()">＋ 項目を追加</button>
            </div>

            <button id="spin-btn" onclick="executeSpin()" class="submit-btn" style="height: 70px; font-size: 1.4rem;">スタート</button>

            <div style="margin-top: 30px; text-align: left;">
                <label style="font-size: 0.8rem; font-weight: bold; opacity: 0.7;">最近の履歴</label>
                <div class="history-list" id="history-box"></div>
            </div>
        </div>
    </main>

    <script src="script.js"></script>

    <script>
        const STORE_ITEMS = 'shino_roulette_items';
        const STORE_LOGS = 'shino_roulette_logs';

        // ページ読み込み時の処理
        window.addEventListener('load', () => {
            const savedItems = JSON.parse(localStorage.getItem(STORE_ITEMS) || '[]');
            const wrapper = document.getElementById('items-wrapper');
            
            if (savedItems.length > 0) {
                savedItems.forEach(text => addNewRow(text));
            } else {
                ['あたり', 'はずれ'].forEach(text => addNewRow(text));
            }
            refreshHistoryUI();
        });

        function addNewRow(val = '') {
            const wrapper = document.getElementById('items-wrapper');
            const div = document.createElement('div');
            div.className = 'row';
            div.innerHTML = `
                <input type="text" class="input-field r-item-text" value="${val}" placeholder="項目名" oninput="saveCurrentItems()">
                <button class="del-btn" onclick="this.parentElement.remove(); saveCurrentItems();">×</button>
            `;
            wrapper.appendChild(div);
            saveCurrentItems();
        }

        function saveCurrentItems() {
            const inputs = document.querySelectorAll('.r-item-text');
            const data = Array.from(inputs).map(i => i.value).filter(v => v.trim() !== "");
            localStorage.setItem(STORE_ITEMS, JSON.stringify(data));
        }

        function refreshHistoryUI() {
            const box = document.getElementById('history-box');
            const logs = JSON.parse(localStorage.getItem(STORE_LOGS) || '[]');
            if (logs.length === 0) {
                box.innerHTML = '<p style="text-align:center; opacity:0.5; font-size:0.8rem;">履歴はありません</p>';
                return;
            }
            box.innerHTML = logs.map(l => `
                <div class="history-item">
                    <span>${l.name}</span>
                    <span style="opacity:0.5; font-size:0.75rem;">${l.time}</span>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm("履歴をすべて削除しますか？")) {
                localStorage.removeItem(STORE_LOGS);
                refreshHistoryUI();
            }
        }

        function executeSpin() {
            const inputs = document.querySelectorAll('.r-item-text');
            const items = Array.from(inputs).map(i => i.value).filter(v => v.trim() !== "");
            
            if (items.length < 2) {
                alert("項目を2つ以上入力してください");
                return;
            }

            const btn = document.getElementById('spin-btn');
            const display = document.getElementById('roulette-target');
            
            btn.disabled = true;
            display.style.color = "var(--text)";
            
            let count = 0;
            const totalSteps = 30;
            
            const animation = () => {
                const randomItem = items[Math.floor(Math.random() * items.length)];
                display.innerText = randomItem;
                count++;

                if (count < totalSteps) {
                    setTimeout(animation, 40 + (count * 6));
                } else {
                    // 確定処理
                    display.style.color = "var(--accent)";
                    
                    // 履歴保存
                    const now = new Date();
                    const timeStr = now.getHours() + ":" + ("0" + now.getMinutes()).slice(-2);
                    const logs = JSON.parse(localStorage.getItem(STORE_LOGS) || '[]');
                    logs.unshift({ name: randomItem, time: timeStr });
                    if (logs.length > 20) logs.pop();
                    localStorage.setItem(STORE_LOGS, JSON.stringify(logs));
                    
                    refreshHistoryUI();
                    btn.disabled = false;
                }
            };
            animation();
        }
    </script>
</body>
</html>
