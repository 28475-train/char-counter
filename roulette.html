<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>確率操作ルーレット | 篠ノ井乗務区</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #roulette-display {
            height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.05);
            border-radius: 24px;
            margin-bottom: 25px;
            border: 3px dashed var(--accent);
            transition: all 0.3s;
        }
        #roulette-target {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--text);
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .settings-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .hint-text {
            font-size: 0.7rem;
            color: var(--text-sub);
            margin-top: -10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <a href="index.html" class="logo-text">ROULETTE Pro</a>
            <div id="status-area"></div>
        </div>
    </header>

    <main class="container">
        <div class="btn-group">
            <button class="menu-btn" onclick="location.href='index.html'">ホーム</button>
            <button class="menu-btn" onclick="clearSettings()">設定初期化</button>
        </div>

        <div class="custom-form">
            <div id="roulette-display">
                <div id="roulette-target">READY</div>
                <div id="probability-info" style="font-size: 0.75rem; color: var(--accent); margin-top: 10px; font-weight: bold;"></div>
            </div>

            <div style="text-align: left;">
                <div class="settings-label">
                    <span>項目と重みの設定</span>
                    <span id="save-status" style="font-weight: normal; color: var(--accent); opacity: 0;">保存済み</span>
                </div>
                <p class="hint-text">「項目名,重み」の形式で入力してください（例：大吉,1）</p>
                <textarea id="roulette-config" rows="8" placeholder="あたり,1&#10;はずれ,10&#10;レア,0.1"></textarea>
            </div>

            <button id="roulette-start" onclick="runProRoulette()" class="submit-btn" style="height: 75px; font-size: 1.5rem; margin-top: 10px;">抽選開始</button>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        // --- ルーレット専用ロジック ---
        const configInput = document.getElementById('roulette-config');
        const target = document.getElementById('roulette-target');
        const probInfo = document.getElementById('probability-info');
        const saveStatus = document.getElementById('save-status');

        // ブラウザから設定を読み込み
        window.onload = () => {
            const saved = localStorage.getItem('roulette_settings');
            if (saved) {
                configInput.value = saved;
            } else {
                configInput.value = "特賞,1\n当たり,5\nハズレ,10";
            }
        };

        // 入力されるたびにブラウザに自動保存
        configInput.addEventListener('input', () => {
            localStorage.setItem('roulette_settings', configInput.value);
            saveStatus.style.opacity = 1;
            setTimeout(() => { saveStatus.style.opacity = 0; }, 1000);
        });

        function clearSettings() {
            if(confirm("設定をリセットしますか？")) {
                localStorage.removeItem('roulette_settings');
                location.reload();
            }
        }

        async function runProRoulette() {
            const lines = configInput.value.split('\n').filter(l => l.trim() !== "");
            let pool = [];
            let totalWeight = 0;

            // 確率計算ロジック
            const items = lines.map(line => {
                const parts = line.split(',');
                const name = parts[0].trim();
                const weight = parseFloat(parts[1]) || 1; // 重みが指定ない場合は1
                totalWeight += weight;
                return { name, weight };
            });

            if (items.length < 2) return alert("項目を2つ以上設定してください");

            const startBtn = document.getElementById('roulette-start');
            startBtn.disabled = true;
            probInfo.innerText = "";
            target.style.color = "var(--text)";

            // 演出用タイマー
            let counter = 0;
            const steps = 30;
            
            const spin = () => {
                // 重みに基づいた抽選
                let random = Math.random() * totalWeight;
                let selected = items[0];
                for (let item of items) {
                    if (random < item.weight) {
                        selected = item;
                        break;
                    }
                    random -= item.weight;
                }

                target.innerText = selected.name;
                counter++;

                if (counter < steps) {
                    setTimeout(spin, 50 + (counter * 5)); // 徐々に遅くなる
                } else {
                    // 確定
                    target.style.color = "var(--accent)";
                    const chance = ((selected.weight / totalWeight) * 100).toFixed(2);
                    probInfo.innerText = `当選確率: ${chance}% (重み: ${selected.weight})`;
                    
                    startBtn.disabled = false;
                    startBtn.innerText = "もう一度引く";
                }
            };

            spin();
        }
    </script>
</body>
</html>
